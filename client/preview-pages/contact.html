<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact &middot; Salesesy Preview</title>
    <link rel="icon" type="image/svg+xml" href="../src/assets/salesesy-logo.svg" />
    <style>
      :root {
        font-family: "Inter", system-ui, Arial, sans-serif;
        --bg: #050f09;
        --bg-alt: radial-gradient(circle at top left, rgba(34, 197, 94, 0.16), transparent 55%);
        --sunken: rgba(6, 23, 14, 0.9);
        --panel: rgba(10, 27, 18, 0.95);
        --surface: rgba(7, 21, 13, 0.92);
        --border: rgba(34, 84, 49, 0.45);
        --border-strong: rgba(61, 132, 89, 0.6);
        --text: #f5fff7;
        --text-soft: #dbe7de;
        --muted: #8fa999;
        --accent: #22c55e;
        --accent-hover: #4ade80;
        --accent-dark: #15803d;
        --accent-soft: rgba(34, 197, 94, 0.22);
        --accent-border-soft: rgba(56, 189, 120, 0.35);
        --ghost-button-bg: rgba(7, 21, 13, 0.9);
        --ghost-button-border: rgba(38, 92, 54, 0.6);
        --primary-text: #042b14;
      }

      body.theme-light {
        --bg: #f7f9fb;
        --bg-alt: radial-gradient(circle at top left, rgba(37, 99, 235, 0.14), transparent 55%);
        --sunken: rgba(255, 255, 255, 0.96);
        --panel: rgba(255, 255, 255, 0.97);
        --surface: rgba(248, 250, 252, 0.96);
        --border: rgba(148, 163, 184, 0.5);
        --border-strong: rgba(100, 116, 139, 0.65);
        --text: #0f172a;
        --text-soft: #1e293b;
        --muted: #475569;
        --accent: #2563eb;
        --accent-hover: #60a5fa;
        --accent-dark: #1d4ed8;
        --accent-soft: rgba(37, 99, 235, 0.18);
        --accent-border-soft: rgba(37, 99, 235, 0.28);
        --ghost-button-bg: rgba(236, 244, 255, 0.9);
        --ghost-button-border: rgba(148, 163, 184, 0.55);
        --primary-text: #eff6ff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        background-image: var(--bg-alt);
        color: var(--text);
        display: flex;
        flex-direction: column;
      }

      .page-chrome {
        position: fixed;
        top: 24px;
        left: 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        align-items: flex-start;
        z-index: 30;
      }

      .theme-toggle {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: space-between;
        width: 60px;
        height: 28px;
        padding: 4px 6px;
        border-radius: 999px;
        border: 1px solid var(--border-strong);
        background: var(--panel);
        cursor: pointer;
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .theme-toggle .toggle-thumb {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        border-radius: 24px;
        background: var(--accent);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
        transition: transform 0.25s ease;
      }
      .theme-toggle .icon {
        display: inline-flex;
        color: var(--muted);
        visibility: hidden;
        opacity: 0;
        transition: color 0.2s ease, opacity 0.2s ease;
      }
      .theme-toggle.dark .icon.moon,
      .theme-toggle.light .icon.sun {
        color: var(--accent);
        visibility: visible;
        opacity: 1;
      }
      .theme-toggle.dark .icon.sun,
      .theme-toggle.light .icon.moon {
        visibility: hidden;
        opacity: 0;
      }
      .theme-toggle.light .toggle-thumb {
        transform: translateX(30px);
      }
      .theme-toggle:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .brand-link {
        text-decoration: none;
        color: inherit;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand-title {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .brand-sub {
        font-size: 0.72rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--muted);
      }

      header {
        display: flex;
        align-items: center;
        gap: 24px;
        padding: 128px 32px 24px;
      }

      .avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: var(--accent-soft);
        border: 1px solid var(--accent-border-soft);
        display: grid;
        place-items: center;
        font-weight: 600;
        font-size: 1.5rem;
        color: var(--accent);
      }

      .header-info h1 {
        margin: 0;
        font-size: 1.8rem;
        letter-spacing: -0.01em;
      }
      .header-info p {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 1rem;
      }
      .header-meta {
        margin-top: 8px;
        color: var(--text-soft);
        font-size: 0.92rem;
      }

      .header-actions {
        margin-left: auto;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      button {
        font: inherit;
        cursor: pointer;
      }

      .ghost {
        border: 1px solid var(--ghost-button-border);
        background: var(--ghost-button-bg);
        color: var(--text);
        padding: 10px 18px;
        border-radius: 999px;
        transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
      }
      .ghost:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .primary {
        border: none;
        background: var(--accent);
        color: var(--primary-text);
        padding: 10px 20px;
        border-radius: 999px;
        font-weight: 600;
        box-shadow: 0 12px 30px rgba(34, 197, 94, 0.25);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(34, 197, 94, 0.3);
      }

      main {
        flex: 1;
        display: flex;
        gap: 24px;
        padding: 0 32px 48px;
        align-items: flex-start;
      }

      aside {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .info-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 22px 24px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .info-card h2 {
        margin: 0;
        font-size: 1.1rem;
      }

      .info-grid {
        display: grid;
        gap: 14px;
      }

      .info-item span {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .info-item strong {
        display: block;
        margin-top: 4px;
        font-weight: 600;
      }

      .info-item a {
        color: var(--accent-hover);
        text-decoration: none;
      }
      .info-item a:hover {
        text-decoration: underline;
      }

      .metric-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .metric-list li {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 12px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
      }

      .metric-list span {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .metric-list strong {
        font-size: 0.98rem;
        color: var(--text-soft);
        font-weight: 600;
      }

      section.timeline {
        flex: 1;
        background: var(--panel);
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 26px 28px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
      }

      .timeline-header h2 {
        margin: 0;
        font-size: 1.15rem;
      }

      .filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .filters button {
        position: relative;
        background: transparent;
        border: 1px solid transparent;
        color: inherit;
        font: inherit;
        padding: 6px 14px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.15s ease, background 0.15s ease, border-color 0.15s ease;
      }
      .filters button.active {
        color: var(--accent);
        background: rgba(34, 197, 94, 0.14);
        border-color: var(--accent-border-soft);
      }
      .filters button:hover {
        color: var(--accent);
      }

      .timeline-list {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .timeline-entry {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 16px;
      }

      .timeline-entry time {
        font-size: 0.82rem;
        color: var(--muted);
        letter-spacing: 0.04em;
      }

      .timeline-card {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: var(--surface);
        padding: 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .timeline-card h3 {
        margin: 0;
        font-size: 1.02rem;
      }

      .timeline-card p {
        margin: 0;
        color: var(--text-soft);
        font-size: 0.94rem;
      }

      .timeline-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 0.82rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: rgba(34, 197, 94, 0.16);
        color: var(--accent);
        border: 1px solid var(--accent-border-soft);
      }

      .empty {
        padding: 18px;
        background: rgba(8, 24, 15, 0.74);
        border: 1px dashed var(--border);
        border-radius: 14px;
        text-align: center;
        color: var(--muted);
      }

      @media (max-width: 1100px) {
        main {
          flex-direction: column;
        }
        aside {
          width: 100%;
          flex-direction: row;
          gap: 18px;
        }
        aside .info-card {
          flex: 1;
        }
        .timeline-entry {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .page-chrome {
          top: 16px;
          left: 16px;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          padding: 128px 20px 24px;
        }
        .header-actions {
          margin-left: 0;
        }
        main {
          padding: 0 20px 32px;
        }
        aside {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body class="theme-dark">
    <div class="page-chrome">
      <button class="theme-toggle dark" type="button" aria-label="Switch to light mode" title="Switch to light mode">
        <span class="toggle-thumb"></span>
        <span class="icon sun" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5" fill="currentColor" opacity="0.15"></circle>
            <circle cx="12" cy="12" r="4" fill="none"></circle>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M5.64 18.36l1.42-1.42M16.94 6.64l1.42-1.42"></path>
          </svg>
        </span>
        <span class="icon moon" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79Z"></path>
          </svg>
        </span>
      </button>
      <a class="brand brand-link" href="../preview.html">
        <img src="../src/assets/salesesy-logo.svg" alt="Salesesy logo" width="36" height="36" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.35));" />
        <div>
          <h2 class="brand-title">Salesesy</h2>
          <div class="brand-sub">Growth CRM</div>
        </div>
      </a>
    </div>

    <header>
      <div class="avatar" id="contact-avatar">AN</div>
      <div class="header-info">
        <h1 id="contact-name">Contact</h1>
        <p id="contact-sub">Role &middot; Company</p>
        <div class="header-meta" id="contact-meta">Owner &middot; Last contacted</div>
      </div>
      <div class="header-actions">
        <button type="button" class="ghost" onclick="goBack()">Back</button>
        <button type="button" class="ghost" id="company-link-button" onclick="openCompany()">View company</button>
        <button type="button" class="primary" onclick="scrollToTimeline()">Review activity</button>
      </div>
    </header>

    <main>
      <aside>
        <div class="info-card">
          <h2>Contact overview</h2>
          <div class="info-grid" id="contact-overview-grid">
            <div class="empty">Loading contact details…</div>
          </div>
        </div>
        <div class="info-card">
          <h2>Engagement snapshot</h2>
          <ul class="metric-list" id="contact-metrics">
            <li><span>Status</span><strong>Loading…</strong></li>
          </ul>
        </div>
      </aside>

      <section class="timeline" id="contact-timeline">
        <div class="timeline-header">
          <h2>Activity timeline</h2>
          <div class="filters" role="tablist">
            <button type="button" role="tab" class="active" data-filter="all" aria-selected="true" tabindex="0">All activity</button>
            <button type="button" role="tab" data-filter="notes" aria-selected="false" tabindex="-1">Notes</button>
            <button type="button" role="tab" data-filter="emails" aria-selected="false" tabindex="-1">Emails</button>
            <button type="button" role="tab" data-filter="calls" aria-selected="false" tabindex="-1">Calls</button>
            <button type="button" role="tab" data-filter="tasks" aria-selected="false" tabindex="-1">Tasks</button>
          </div>
        </div>

        <div class="timeline-body">
          <div class="timeline-list" id="timeline">
            <div class="empty">Select a contact to see their recent activity.</div>
          </div>
        </div>
      </section>
    </main>
    <script>
      const THEME_KEY = "salesesy-theme";
      const storageKey = "preview-companies";
      const pageBody = document.body;
      const themeToggle = document.querySelector(".theme-toggle");

      const applyTheme = (value) => {
        const next = value === "light" ? "light" : "dark";
        pageBody.classList.remove("theme-dark", "theme-light");
        pageBody.classList.add(`theme-${next}`);
        if (themeToggle) {
          themeToggle.classList.remove("dark", "light");
          themeToggle.classList.add(next);
          const label = next === "dark" ? "Switch to light mode" : "Switch to dark mode";
          themeToggle.setAttribute("aria-label", label);
          themeToggle.setAttribute("title", label);
        }
      };

      applyTheme(window.localStorage.getItem(THEME_KEY));
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const next = pageBody.classList.contains("theme-dark") ? "light" : "dark";
          window.localStorage.setItem(THEME_KEY, next);
          applyTheme(next);
        });
      }

      const params = new URLSearchParams(window.location.search);
      const slug = (params.get("company") || "").trim().toLowerCase();
      const requestedContactId = (params.get("contact") || "").trim().toLowerCase();

      const avatarEl = document.getElementById("contact-avatar");
      const nameEl = document.getElementById("contact-name");
      const roleEl = document.getElementById("contact-sub");
      const metaEl = document.getElementById("contact-meta");
      const overviewGrid = document.getElementById("contact-overview-grid");
      const metricsList = document.getElementById("contact-metrics");
      const companyButton = document.getElementById("company-link-button");
      const timelineEl = document.getElementById("timeline");
      const filterButtons = document.querySelectorAll(".filters button[data-filter]");

      let timelineData = [];
      let activeFilter = "all";

      const escapeHtml = (value = "") =>
        String(value).replace(/[&<>"']/g, (char) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[char] || char));

      const initials = (name) => {
        if (!name) return "CL";
        const parts = name.trim().split(/\s+/);
        if (!parts.length) return "CL";
        const first = parts[0][0] || "";
        const second = parts.length > 1 ? parts[parts.length - 1][0] : "";
        return (first + second).toUpperCase();
      };

      const normalizeString = (value) => (typeof value === "string" ? value.trim() : "");
      const slugify = (value, fallback) => {
        if (!value) return fallback;
        const slug = String(value)
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "")
          .slice(0, 42);
        return slug || fallback;
      };
      const deriveContactId = (raw, index) => {
        const candidates = [
          raw?.id,
          raw?.contact_id,
          raw?.contactId,
          raw?.uid,
          raw?.slug,
          raw?.handle,
          raw?.email,
          raw?.email_address,
          raw?.emailAddress,
          raw?.phone,
          raw?.phone_number,
          raw?.phoneNumber,
          raw?.name,
          `${raw?.first_name || ""} ${raw?.last_name || ""}`,
        ];
        for (const candidate of candidates) {
          const slug = slugify(candidate, "");
          if (slug) return slug;
        }
        return `contact-${index + 1}`;
      };

      const formatDate = (date) =>
        date.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

      const normalizeContact = (raw, index) => {
        if (!raw || typeof raw !== "object") return null;
        const firstName = normalizeString(raw.first_name ?? raw.firstName);
        const lastName = normalizeString(raw.last_name ?? raw.lastName);
        const name = normalizeString(raw.name) || [firstName, lastName].filter(Boolean).join(" ");
        const email = normalizeString(raw.email ?? raw.email_address ?? raw.emailAddress);
        const phone = normalizeString(raw.phone ?? raw.phone_number ?? raw.phoneNumber);
        const title = normalizeString(raw.title ?? raw.job_title ?? raw.jobTitle ?? raw.role ?? raw.position);
        const relationship = normalizeString(raw.relationship ?? raw.relation ?? raw.department ?? raw.team);
        const owner = normalizeString(raw.owner ?? raw.contact_owner ?? raw.ownerName ?? raw.assigned_to ?? raw.assignedTo);
        const lifecycle = normalizeString(raw.lifecycle_stage ?? raw.lifecycle ?? raw.stage);
        const status = normalizeString(raw.status ?? raw.lead_status ?? raw.state);
        const leadSource = normalizeString(raw.lead_source ?? raw.source ?? raw.acquisition_channel);
        const region = normalizeString(raw.region ?? raw.location ?? raw.market ?? raw.city);
        const lastContacted = normalizeString(raw.last_contacted ?? raw.lastActivity ?? raw.last_activity);
        const added = normalizeString(raw.added_at ?? raw.created_at ?? raw.updated_at ?? raw.last_updated);
        const scoreRaw = raw.lead_score ?? raw.score ?? raw.fit_score;
        const scoreParsed = Number.parseInt(scoreRaw, 10);
        return {
          id: deriveContactId(raw, index),
          name,
          firstName,
          lastName,
          email,
          phone,
          title,
          relationship,
          owner,
          lifecycle,
          status,
          leadSource,
          region,
          lastContacted,
          added,
          score: Number.isFinite(scoreParsed) ? scoreParsed : 68,
          raw,
        };
      };

      const renderTimeline = (filter) => {
        if (!timelineEl) return;
        const scoped = filter === "all" ? timelineData : timelineData.filter((item) => item.category === filter);
        if (!scoped.length) {
          timelineEl.innerHTML = `<div class="empty">No ${filter === "all" ? "" : `${filter} `}activity logged yet.</div>`;
          return;
        }
        timelineEl.innerHTML = scoped
          .map(
            (item) => `
              <div class="timeline-entry">
                <time>${escapeHtml(item.time)}</time>
                <div class="timeline-card">
                  <div class="pill">${escapeHtml(item.label)}</div>
                  <h3>${escapeHtml(item.subject)}</h3>
                  <p>${escapeHtml(item.body)}</p>
                  ${
                    item.meta?.length
                      ? `<div class="timeline-meta">${item.meta
                          .map((line) => `<span>${escapeHtml(line)}</span>`)
                          .join("")}</div>`
                      : ""
                  }
                </div>
              </div>
            `
          )
          .join("");
      };

      const setFilter = (nextFilter) => {
        activeFilter = nextFilter;
        filterButtons.forEach((btn) => {
          const isActive = btn.dataset.filter === nextFilter;
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-selected", isActive ? "true" : "false");
          btn.tabIndex = isActive ? 0 : -1;
        });
        renderTimeline(nextFilter);
      };

      filterButtons.forEach((btn) => btn.addEventListener("click", () => setFilter(btn.dataset.filter || "all")));

      function goBack() {
        if (window.history.length > 1) {
          window.history.back();
        } else if (slug) {
          window.location.href = `company.html?company=${encodeURIComponent(slug)}`;
        } else {
          window.location.href = "../preview.html";
        }
      }

      function openCompany() {
        if (!slug) return;
        window.location.href = `company.html?company=${encodeURIComponent(slug)}`;
      }

      function scrollToTimeline() {
        document.getElementById("contact-timeline")?.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      const showEmptyState = (title, message) => {
        document.title = `${title} \u00b7 Salesesy Preview`;
        nameEl.textContent = title;
        roleEl.textContent = "Return to the list and pick another contact.";
        metaEl.textContent = "";
        overviewGrid.innerHTML = `<div class="empty">${escapeHtml(message)}</div>`;
        metricsList.innerHTML = `<li><span>Status</span><strong>Unavailable</strong></li>`;
        timelineData = [];
        activeFilter = "all";
        setFilter(activeFilter);
        if (companyButton) companyButton.disabled = !slug;
      };

      function render() {
        if (!slug) {
          showEmptyState("Contact not specified", "Missing company parameter in the URL.");
          return;
        }

        const store = JSON.parse(window.localStorage.getItem(storageKey) || "{}");
        const record = store[slug];
        if (!record) {
          showEmptyState("Company not found", "Local storage does not have a record for this company.");
          return;
        }

        const createdDate = record.created_at ? new Date(record.created_at) : new Date();
        const relatedContacts = Array.isArray(record.contacts) ? record.contacts.filter((item) => item && typeof item === "object") : [];
        const fallbackContact = {
          first_name: record.first_name,
          last_name: record.last_name,
          title: record.title,
          email: record.email,
          phone: record.phone,
          relationship: record.relationship || record.role || "",
          added_at: createdDate.toISOString(),
          owner: record.owner || record.assigned_to || "You",
        };
        const fallbackHasDetails =
          fallbackContact.first_name ||
          fallbackContact.last_name ||
          fallbackContact.email ||
          fallbackContact.phone ||
          fallbackContact.title;
        const emailAlreadyTracked =
          fallbackContact.email &&
          relatedContacts.some((contact) => {
            const rawEmail =
              contact?.email ?? contact?.email_address ?? contact?.emailAddress ?? contact?.primaryEmail;
            return (
              typeof rawEmail === "string" &&
              rawEmail.trim().toLowerCase() === fallbackContact.email.trim().toLowerCase()
            );
          });
        const rawContacts = fallbackHasDetails && !emailAlreadyTracked
          ? [fallbackContact, ...relatedContacts]
          : relatedContacts;

        const normalizedContacts = rawContacts.map((raw, index) => normalizeContact(raw, index)).filter(Boolean);

        const contact =
          normalizedContacts.find((item) => item.id.toLowerCase() === requestedContactId) ||
          normalizedContacts.find((item) => item.email && item.email.toLowerCase() === requestedContactId) ||
          normalizedContacts[0];

        if (!contact) {
          showEmptyState("Contact not found", "This company does not have an associated contact yet.");
          return;
        }

        document.title = `${contact.name || "Contact"} \u00b7 Salesesy Preview`;
        if (companyButton) {
          companyButton.disabled = false;
          companyButton.title = record.company ? `View ${record.company}` : "View company record";
        }

        const companyName = record.company || "Company not specified";
        const displayName = contact.name || "Contact name not specified";
        const roleCopy = contact.title ? `${contact.title}${companyName ? ` \u00b7 ${companyName}` : ""}` : companyName;
        const ownerName = contact.owner || record.owner || record.assigned_to || "Unassigned";
        const lifecycle = contact.lifecycle || "Prospect";
        const status = contact.status || "Active";
        const leadSource = contact.leadSource || record.lead_source || "Web form";
        const region = contact.region || record.city || record.country || "Not specified";
        const lastTouch = contact.lastContacted || contact.added || createdDate.toLocaleDateString();

        avatarEl.textContent = initials(displayName);
        nameEl.textContent = displayName;
        roleEl.textContent = roleCopy || "Role not specified";
        metaEl.textContent = `${ownerName} \u00b7 Last touch ${lastTouch}`;

        overviewGrid.innerHTML = `
          <div class="info-item">
            <span>Email</span>
            <strong>${
              contact.email
                ? `<a href="mailto:${encodeURI(contact.email)}">${escapeHtml(contact.email)}</a>`
                : "Not specified"
            }</strong>
          </div>
          <div class="info-item">
            <span>Phone</span>
            <strong>${
              contact.phone
                ? `<a href="tel:${encodeURIComponent(contact.phone.replace(/[^0-9+]/g, "") || contact.phone)}">${escapeHtml(contact.phone)}</a>`
                : "Not specified"
            }</strong>
          </div>
          <div class="info-item">
            <span>Company</span>
            <strong>${
              record.company
                ? `<a href="company.html?company=${encodeURIComponent(slug)}">${escapeHtml(record.company)}</a>`
                : "Not specified"
            }</strong>
          </div>
          <div class="info-item">
            <span>Relationship</span>
            <strong>${contact.relationship ? escapeHtml(contact.relationship) : "Not specified"}</strong>
          </div>
          <div class="info-item">
            <span>Location</span>
            <strong>${
              record.city || record.country
                ? [record.city, record.country].filter(Boolean).map(escapeHtml).join(", ")
                : region ? escapeHtml(region) : "Not specified"
            }</strong>
          </div>
          <div class="info-item">
            <span>Added</span>
            <strong>${contact.added ? escapeHtml(contact.added) : escapeHtml(formatDate(createdDate))}</strong>
          </div>
          <div class="info-item">
            <span>Lead source</span>
            <strong>${leadSource ? escapeHtml(leadSource) : "Not specified"}</strong>
          </div>
          <div class="info-item">
            <span>Lifecycle stage</span>
            <strong>${escapeHtml(lifecycle)}</strong>
          </div>
        `;

        const upcomingTaskDate = new Date(createdDate.getTime() + 48 * 60 * 60 * 1000);
        const lastEmailDate = new Date(createdDate.getTime() + 2 * 60 * 60 * 1000);
        const lastCallDate = new Date(createdDate.getTime() + 4 * 60 * 60 * 1000);
        const openTasks = [
          {
            title: `Follow up with ${contact.firstName || contact.name || "the lead"}`,
            due: formatDate(upcomingTaskDate),
          },
        ];

        metricsList.innerHTML = `
          <li><span>Lead status</span><strong>${escapeHtml(status)}</strong></li>
          <li><span>Lead score</span><strong>${escapeHtml(String(contact.score))}</strong></li>
          <li><span>Owner</span><strong>${escapeHtml(ownerName)}</strong></li>
          <li><span>Last email</span><strong>${escapeHtml(formatDate(lastEmailDate))}</strong></li>
          <li><span>Last call</span><strong>${escapeHtml(formatDate(lastCallDate))}</strong></li>
          <li><span>Open tasks</span><strong>${escapeHtml(openTasks.length ? openTasks[0].due : "None")}</strong></li>
        `;

        const contactLabel = contact.name || contact.firstName || "this lead";
        const emailSummary = contact.email ? `Recap sent to ${contact.email}` : "Shared trial overview with the lead.";
        const callSummary = contact.phone ? `Called ${contact.phone} to confirm next steps.` : "Follow-up conversation logged.";

        timelineData = [
          {
            time: formatDate(createdDate),
            label: "Record",
            subject: "Contact created",
            body: `Record created for ${contactLabel}.`,
            category: "notes",
            meta: [record.company || "Company not specified"],
          },
          {
            time: formatDate(new Date(createdDate.getTime() + 30 * 60 * 1000)),
            label: "Notes",
            subject: "Discovery call summary",
            body: "Captured initial goals and pain points following the intro call.",
            category: "notes",
            meta: [`Owner \u00b7 ${ownerName}`],
          },
          {
            time: formatDate(lastEmailDate),
            label: "Email",
            subject: "Enablement resources sent",
            body: emailSummary,
            category: "emails",
            meta: ["Sent by you"],
          },
          {
            time: formatDate(lastCallDate),
            label: "Call",
            subject: "Qualification call completed",
            body: callSummary,
            category: "calls",
            meta: ["Scheduled 30 min \u00b7 Completed"],
          },
          {
            time: formatDate(upcomingTaskDate),
            label: "Task",
            subject: "Schedule pricing review",
            body: `Coordinate next touch with ${contactLabel} and share updated pricing.`,
            category: "tasks",
            meta: [`Due ${formatDate(upcomingTaskDate)}`],
          },
        ];

        activeFilter = "all";
        setFilter(activeFilter);
      }

      render();
    </script>
  </body>
</html>

